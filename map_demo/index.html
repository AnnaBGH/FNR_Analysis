<html><body>
  <div id="mapdiv"></div>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script> 
  <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
  <script src="image.js"></script> 
  <script>
    map = new OpenLayers.Map("mapdiv");
    map.addLayer(new OpenLayers.Layer.OSM("Humanitarian Style",                                                   
                                           ["http://a.tile.openstreetmap.fr/hot/${z}/${x}/${y}.png",
                                            "http://b.tile.openstreetmap.fr/hot/${z}/${x}/${y}.png",
                                            "http://c.tile.openstreetmap.fr/hot/${z}/${x}/${y}.png"],
                                            {attribution: "Â© <a href='http://www.openstreetmap.org/'>OpenStreetMap</a> and contributors, under an <a href='http://www.openstreetmap.org/copyright' title='ODbL'>open license</a>. Humanitarian style by <a href='http://hot.openstreetmap.org'>H.O.T.</a>",
					    "tileOptions": { "crossOriginKeyword": null }}));
 
    var epsg4326 =  new OpenLayers.Projection("EPSG:4326"); //WGS 1984 projection
    var projectTo = map.getProjectionObject();

    var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
    var kmllayer = new OpenLayers.Layer.Vector("KML");


//    $.getJSON( "stations.json", function( data ) {
    $.getJSON( "silvertown.json", function( data ) {
	for (i=0;i<data.length;i++) {
//	for (i=20;i<30;i++) {
		station = data[i];
		console.log(i + " " + station.name);
		var feature = new OpenLayers.Feature.Vector(
                	new OpenLayers.Geometry.Point( station.longitude, station.latitude ).transform(epsg4326, projectTo),
                	{description: station.name} ,
                	{externalGraphic: 'icon_firetruck.png', graphicHeight: 25, graphicWidth: 21, graphicXOffset:-12, graphicYOffset:-25  }
            	);             
        	vectorLayer.addFeatures(feature);
		
//		$.get(
//   		  "stations_kml/"+station.name+".kml",
//   		  function(data, textStatus, jqXHR) {
		   var kmllayer = new OpenLayers.Layer.Vector("KML", {
			strategies: [new OpenLayers.Strategy.Fixed()],
			protocol: new OpenLayers.Protocol.HTTP({
				url: "stations_kml/"+station.name+".kml",
				format: new OpenLayers.Format.KML({
					extractStyles: true, 
					extractAttributes: true,
					maxDepth: 2
				})
			})
		   });
    		   map.addLayer(kmllayer);
//		});
    	}
});  


    var zoom=12;
    var lonLat = new OpenLayers.LonLat( -0.1279688 ,51.5077286 )
	          .transform(
        	    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            	    map.getProjectionObject() // to Spherical Mercator Projection
          	  );

    map.setCenter(lonLat, zoom);
    map.addLayer(vectorLayer);
   
   var controls = {
      selector: new OpenLayers.Control.SelectFeature(vectorLayer, { onSelect: createPopup, onUnselect: destroyPopup })
    };

    function createPopup(feature) {
      feature.popup = new OpenLayers.Popup.FramedCloud("pop",
          feature.geometry.getBounds().getCenterLonLat(),
          null,
          '<div class="markerContent">'+feature.attributes.description+'</div>',
          null,
          true,
          function() { controls['selector'].unselectAll(); }
      );
      //feature.popup.closeOnMove = true;
      map.addPopup(feature.popup);
    }

    function destroyPopup(feature) {
      feature.popup.destroy();
      feature.popup = null;
    }
    
    map.addControl(controls['selector']);
    controls['selector'].activate();
 
  </script>
</body></html>
